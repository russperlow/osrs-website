<!DOCTYPE html>
<html lang="en">
<head>
  <title>Our simple HTTP server</title>
  <link rel="stylesheet" type="text/css" href="/main.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>

  <script type="text/babel">
  const parseJSON = (xhr, content) => {
    const obj = JSON.parse(xhr.response);

    //console.log(obj);

    console.log('parseJSON');
    // add message to screen if it exists
    if(obj.message){
      const p = document.createElement('p');
      p.textContent = `Message: ${obj.message}`;
      content.appendChild(p)
    }

    // Add user to screen if they exist
    if(obj.users){
      const userList = document.createElement('p');
      const users = JSON.stringify(obj.users);
      // console.log(obj.users);
      // console.log(users);
      userList.textContent = users;
      content.appendChild(userList);
    }
  };

  const handleResponse = (xhr, parseResponse) => {
    const content = document.querySelector('#content');

    switch(xhr.status){
      case 200:
        content.innerHTML = '<b>Success</b>';
        break;
      case 201:
      content.innerHTML = '<b>Create</b>';
        break;
      case 204:
      content.innerHTML = '<b>Updated (no content)</b>';
        break;
      case 400:
      content.innerHTML = '<b>Bad request</b>';
        break;
      case 404:
      content.innerHTML = '<b>Resource not found</b>';
        break;
      default:
      content.innerHTML = '<b>Error Code not implemented by client</b>';
        break;
    }

    if(parseResponse){
      parseJSON(xhr, content);
    }
  };

  const post = (e, nameForm) => {
    const nameAction = nameForm.getAttribute('action');
    const nameMethod = nameForm.getAttribute('method');

    const nameField = nameForm.querySelector('#nameField');
    const ageField = nameForm.querySelector('#ageField');

    const xhr = new XMLHttpRequest();
    xhr.open(nameMethod, nameAction);

    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.setRequestHeader('Accept', 'application/json');
    xhr.onload = () => handleResponse(xhr, true);

    const formData = `name=${nameField.value}&age=${ageField.value}`;
    xhr.send(formData);

    e.preventDefault();
    return false;
  }

  const requestUpdate = (e, userForm) => {
    const url = userForm.querySelector('#urlField').value;
    const type = userForm.querySelector('#methodSelect').value;

    const xhr = new XMLHttpRequest();

    xhr.open(type, url);
    xhr.setRequestHeader('Accept', type);

    if(type == 'get'){
      xhr.onload = () => handleResponse(xhr, true);
    }else{
      xhr.onload = () => handleResponse(xhr, false);
    }

    xhr.send();
    e.preventDefault();
    return false;
  }

  const init = () => {
    const nameForm = document.querySelector('#nameForm');
    const userForm = document.querySelector('#userForm');

    const addUser = (e) => post(e, nameForm);
    const getResponses = (e) => requestUpdate(e, userForm);

    nameForm.addEventListener('submit', addUser);
    userForm.addEventListener('submit', getResponses);
  }
  window.onload = init;
  </script>
</head>
<body>
  <h1>Russ' OSRS Helper</h1>

  <div class='nav'>
      <a href='ge.html' class='nav-link'>Grand Exchange</a>
      <a href='droprate.html' class='nav-link'>Drop Rate</a>
  </div>

  <h2 id='welcome-text'>Welcome to Russ' OSRS Helper! Current tools are the Grand Exchange Tracker and the Drop Calculator</h2>
  <h3 class='intro-title'>Grand Exchange:</h3>
  <p class='intro-text'>
      The Grand Exchange Calculator uses the average sale of the last 180 days. All tradable items, both F2P and P2P can be
      looked up for their prices. Along with day to day prices, the items trend can be viewed, perfect for merching. Along
      with the graph, the items are displayed with their low and high alchemy values, and percentages of increase/decrease in price 
      over the last 30, 90 and 180 days.
  </p>
  <h3 class='intro-title'>Drop Rate Calc:</h3>
  <p class='intro-text'>
      The drop rate calculator will help show a visual representation for where you stand based on your current kill count for a drop
      and the probability you would have received the drop by now, along with the chance over either double your current kill count or
      the drop rate (whichever is larger). There is also a built in feature for pet kill counts. You may toggle that option, enter your
      RSN and which boss you would like to calculate. The information will be pulled from the most recently update OSRS hiscores page. 
      If your numbers seem in correct, you may need to log out or view your collection log to make sure it properly updates.
  </p>
  <footer>
      <small id='footer'>&copy; Copyright 2019, Russell Perlow</small>
  </footer>
</body>
</html>